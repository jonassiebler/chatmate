name: Validate Chatmates

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Repository Structure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate directory structure
      run: |
        echo "üîç Validating repository structure..."
        
        # Check required directories
        required_dirs=(
          "mates"
          ".github"
          ".github/workflows"
          ".github/ISSUE_TEMPLATE"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Missing required directory: $dir"
            exit 1
          else
            echo "‚úÖ Found directory: $dir"
          fi
        done
        
        # Check required files
        required_files=(
          "README.md"
          "CONTRIBUTING.md"
          "hire.sh"
          ".github/pull_request_template.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Missing required file: $file"
            exit 1
          else
            echo "‚úÖ Found file: $file"
          fi
        done
        
        echo "üéâ Repository structure validation passed!"

  validate-chatmates:
    runs-on: ubuntu-latest
    name: Validate Chatmate Files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate chatmate syntax
      run: |
        echo "ü§ñ Validating chatmate files..."
        
        # Check if mates directory exists and has content
        if [ ! -d "mates" ]; then
          echo "‚ùå mates directory not found"
          exit 1
        fi
        
        # Count chatmate files
        chatmate_count=$(find mates -name "*.chatmode.md" | wc -l)
        echo "üìä Found $chatmate_count chatmate files"
        
        if [ $chatmate_count -eq 0 ]; then
          echo "‚ùå No chatmate files found in mates directory"
          exit 1
        fi
        
        # Validate each chatmate file
        error_count=0
        
        for file in mates/*.chatmode.md; do
          if [ -f "$file" ]; then
            echo "üîç Validating: $(basename "$file")"
            
            # Check file naming convention
            if [[ ! "$(basename "$file")" =~ \.chatmode\.md$ ]]; then
              echo "‚ùå Invalid file extension: $(basename "$file")"
              ((error_count++))
              continue
            fi
            
            # Check if file is not empty
            if [ ! -s "$file" ]; then
              echo "‚ùå Empty file: $(basename "$file")"
              ((error_count++))
              continue
            fi
            
            # Check for basic content structure
            if ! grep -q "^#" "$file"; then
              echo "‚ö†Ô∏è Warning: No headers found in $(basename "$file")"
            fi
            
            # Check file size (should be reasonable for a prompt)
            file_size=$(wc -c < "$file")
            if [ $file_size -gt 50000 ]; then
              echo "‚ö†Ô∏è Warning: Large file size for $(basename "$file"): $file_size bytes"
            fi
            
            echo "‚úÖ $(basename "$file") passed validation"
          fi
        done
        
        if [ $error_count -gt 0 ]; then
          echo "‚ùå Found $error_count validation errors"
          exit 1
        fi
        
        echo "üéâ All chatmate files validated successfully!"

  test-installation:
    runs-on: ${{ matrix.os }}
    name: Test Installation Script
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test hire.sh script
      run: |
        echo "üß™ Testing installation script on ${{ runner.os }}..."
        
        # Make script executable
        chmod +x hire.sh
        
        # Check script syntax
        bash -n hire.sh
        echo "‚úÖ Script syntax check passed"
        
        # Test dry run (without actual installation)
        echo "üîç Testing script logic..."
        
        # Verify mates directory exists
        if [ ! -d "mates" ]; then
          echo "‚ùå mates directory not found"
          exit 1
        fi
        
        # Count files to be copied
        file_count=$(find mates -name "*.md" | wc -l)
        echo "üìÅ Found $file_count markdown files to install"
        
        if [ $file_count -eq 0 ]; then
          echo "‚ùå No markdown files found in mates directory"
          exit 1
        fi
        
        echo "‚úÖ Installation script test passed"

  lint-markdown:
    runs-on: ubuntu-latest
    name: Lint Markdown Files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install markdownlint
      run: npm install -g markdownlint-cli
      
    - name: Lint markdown files
      run: |
        echo "üìù Linting markdown files..."
        
        # Create markdownlint config
        cat > .markdownlint.json << 'EOF'
        {
          "MD013": false,
          "MD041": false,
          "MD033": false,
          "MD034": false
        }
        EOF
        
        # Lint all markdown files
        markdownlint "**/*.md" --config .markdownlint.json
        
        echo "‚úÖ Markdown linting completed"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security checks
      run: |
        echo "üîí Running security checks..."
        
        # Check for potential sensitive information
        echo "üîç Checking for sensitive data patterns..."
        
        # Define patterns to check
        sensitive_patterns=(
          "password"
          "secret"
          "token"
          "api[_-]?key"
          "private[_-]?key"
          "access[_-]?key"
        )
        
        error_count=0
        
        for pattern in "${sensitive_patterns[@]}"; do
          if grep -ri "$pattern" mates/ --exclude-dir=.git; then
            echo "‚ö†Ô∏è Found potential sensitive data: $pattern"
            ((error_count++))
          fi
        done
        
        # Check for executable files in mates directory
        if find mates/ -type f -executable | grep -q .; then
          echo "‚ö†Ô∏è Found executable files in mates directory"
          find mates/ -type f -executable
          ((error_count++))
        fi
        
        if [ $error_count -gt 0 ]; then
          echo "‚ùå Security scan found $error_count issues"
          echo "‚ÑπÔ∏è Please review the flagged content before proceeding"
        else
          echo "‚úÖ Security scan passed"
        fi

  check-links:
    runs-on: ubuntu-latest
    name: Check Links
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install markdown-link-check
      run: npm install -g markdown-link-check
      
    - name: Check links in markdown files
      run: |
        echo "üîó Checking links in markdown files..."
        
        # Create config file for link checking
        cat > .markdown-link-check.json << 'EOF'
        {
          "ignorePatterns": [
            {
              "pattern": "^https://www.google.com"
            }
          ],
          "timeout": "10s",
          "retryOn429": true,
          "aliveStatusCodes": [200, 206]
        }
        EOF
        
        # Check links in all markdown files
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | \
        xargs -I {} markdown-link-check {} --config .markdown-link-check.json
        
        echo "‚úÖ Link checking completed"
