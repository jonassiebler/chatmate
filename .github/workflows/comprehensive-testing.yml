name: Comprehensive Testing

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  GO_VERSION: '1.23.x'

jobs:
  test-framework:
    runs-on: ${{ matrix.os }}
    name: Test Framework - ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
        
    - name: Download dependencies
      run: go mod download
      
    - name: Verify dependencies
      run: go mod verify
        
    - name: Run comprehensive test suite
      run: |
        echo "ðŸ§ª Running ChatMate comprehensive test suite..."
        chmod +x scripts/run-tests.sh
        ./scripts/run-tests.sh
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: test-results.log
        
    - name: Test installation script
      run: |
        echo "ðŸ”§ Testing installation script..."
        chmod +x scripts/hire.sh
        
        # Test script syntax
        bash -n scripts/hire.sh
        
        # Test with mock environment
        echo "Testing installation process..."
        mkdir -p /tmp/test-prompts
        export HOME=/tmp
        export OSTYPE="linux-gnu"
        
        # Mock the installation process
        MOCK_PROMPTS_DIR="/tmp/test-prompts"
        mkdir -p "$MOCK_PROMPTS_DIR"
        cp -v internal/assets/mates/*.md "$MOCK_PROMPTS_DIR"/ 2>/dev/null || echo "No .md files to copy"
        
        echo "âœ… Installation test completed"
        
    - name: Validate chatmate files
      run: |
        echo "ðŸ“‹ Validating chatmate files..."
        
        # Check all chatmate files exist and are valid
        chatmate_count=$(find internal/assets/mates -name "*.chatmode.md" | wc -l)
        echo "Found $chatmate_count chatmate files"
        
        if [ $chatmate_count -eq 0 ]; then
          echo "âŒ No chatmate files found"
          exit 1
        fi
        
        # Validate each chatmate file
        for file in internal/assets/mates/*.chatmode.md; do
          echo "Validating: $(basename "$file")"
          
          # Check YAML frontmatter
          if ! head -n 1 "$file" | grep -q "^---"; then
            echo "âŒ Missing YAML frontmatter in $(basename "$file")"
            exit 1
          fi
          
          # Check for required fields
          if ! grep -q "description:" "$file"; then
            echo "âŒ Missing description in $(basename "$file")"
            exit 1
          fi
          
          # Skip model and tools checks as they may not be in all chatmate files
          
          echo "âœ… $(basename "$file") is valid"
        done
        
        echo "ðŸŽ‰ All chatmate files validated successfully!"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security checks
      run: |
        echo "ðŸ”’ Running security checks..."
        
        # Check for potential sensitive information
        echo "ðŸ” Checking for sensitive data patterns..."
        
        sensitive_patterns=("password" "secret" "token" "api[_-]?key" "private[_-]?key")
        error_count=0
        
        for pattern in "${sensitive_patterns[@]}"; do
          if grep -ri "$pattern" mates/ --exclude-dir=.git; then
            echo "âš ï¸ Found potential sensitive data: $pattern"
            ((error_count++))
          fi
        done
        
        if [ $error_count -gt 0 ]; then
          echo "âŒ Security scan found $error_count issues"
          exit 1
        else
          echo "âœ… Security scan passed"
        fi

  markdown-quality:
    runs-on: ubuntu-latest
    name: Markdown Quality Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install markdownlint
      run: npm install -g markdownlint-cli
      
    - name: Create markdownlint config
      run: |
        cat > .markdownlint.json << 'EOF'
        {
          "MD013": false,
          "MD041": false,
          "MD033": false,
          "MD034": false,
          "MD032": false
        }
        EOF
        
    - name: Lint markdown files
      run: |
        echo "ðŸ“ Linting markdown files..."
        markdownlint "**/*.md" --config .markdownlint.json
        echo "âœ… Markdown linting completed"

  shell-quality:
    runs-on: ubuntu-latest
    name: Shell Script Quality Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        
    - name: Check shell scripts
      run: |
        echo "ðŸš Checking shell script quality..."
        
        # Check hire.sh
        shellcheck scripts/hire.sh
        
        # Check test runner
        shellcheck scripts/run-tests.sh
        
        # Check any other shell scripts
        find scripts -name "*.sh" -exec shellcheck {} \;
        
        echo "âœ… Shell script quality check completed"

  cross-platform-test:
    runs-on: ${{ matrix.os }}
    name: Cross-Platform Compatibility - ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test cross-platform compatibility
      shell: bash
      run: |
        echo "ðŸŒ Testing cross-platform compatibility on ${{ runner.os }}..."
        
        # Check file structure
        if [ ! -d "internal/assets/mates" ]; then
          echo "âŒ mates directory not found"
          exit 1
        fi
        
        # Check hire.sh exists
        if [ ! -f "scripts/hire.sh" ]; then
          echo "âŒ hire.sh not found"
          exit 1
        fi
        
        # Test script syntax
        bash -n scripts/hire.sh
        
        # Count chatmate files
        chatmate_count=$(find internal/assets/mates -name "*.chatmode.md" | wc -l)
        echo "Found $chatmate_count chatmate files"
        
        if [ $chatmate_count -eq 0 ]; then
          echo "âŒ No chatmate files found"
          exit 1
        fi
        
        echo "âœ… Cross-platform compatibility test passed on ${{ runner.os }}"

  test-coverage:
    runs-on: ubuntu-latest
    name: Test Coverage Analysis
    needs: [test-framework]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        name: test-results-ubuntu-latest
        
    - name: Analyze test coverage
      run: |
        echo "ðŸ“Š Analyzing test coverage..."
        
        if [ -f "test-results.log" ]; then
          echo "Test results found:"
          cat test-results.log
          
          # Extract test statistics
          if grep -q "Success Rate:" test-results.log; then
            success_rate=$(grep "Success Rate:" test-results.log | cut -d' ' -f3)
            echo "Test Success Rate: $success_rate"
            
            # Require at least 80% success rate
            rate_num=$(echo "$success_rate" | sed 's/%//')
            if [ "$rate_num" -lt 80 ]; then
              echo "âŒ Test success rate below 80%"
              exit 1
            fi
          fi
          
          echo "âœ… Test coverage analysis completed"
        else
          echo "âš ï¸ No test results found"
        fi
